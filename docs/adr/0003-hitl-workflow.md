# ADR-0003: HITL (Human-in-the-Loop) 工作流设计

## 状态

**已采纳** - 2025-01-01

## 背景

OpenTruss 的核心场景是数据清洗和质量提升。AI Agent 识别施工图（DWG）后，生成的初始数据可能存在以下问题：

1. **拓扑错误**: 墙体连接关系不正确
2. **参数缺失**: Z 轴高度、材质等信息缺失
3. **分类错误**: 构件没有正确归类到 GB50300 层级结构中

完全自动化的方案无法保证数据质量，需要人工参与进行数据清洗和验证。

## 决策

采用 **HITL (Human-in-the-Loop)** 工作流设计，通过三种交互模式让数据工程师参与数据清洗过程：

1. **Trace Mode**: 修复 2D 拓扑关系
2. **Lift Mode**: 批量设置 Z 轴参数
3. **Classify Mode**: 拖拽归类构件到层级结构

### 工作流设计原则

1. **宽进严出**: 
   - 数据摄入阶段允许不完整数据进入（状态：DRAFT）
   - 导出前必须通过完整性验证（状态：VERIFIED/APPROVED）

2. **渐进式完善**:
   - 数据工程师可以分阶段完善数据
   - 每个阶段都有明确的完成标准

3. **实时反馈**:
   - 用户操作立即反映到图数据库
   - 前端提供即时的视觉反馈

4. **状态管理**:
   - 使用状态机管理 Element 和 InspectionLot 的生命周期
   - 状态转换有明确的触发条件

## 理由

### 为什么需要 HITL？

1. **AI 识别的局限性**:
   - AI 可以识别几何形状，但难以理解工程语义
   - 拓扑关系的正确性需要工程经验判断
   - 层级结构的归类需要领域知识

2. **数据质量要求**:
   - IFC 导出需要完整准确的数据
   - GB50300 标准要求严格的数据结构
   - 下游 BIM 软件对数据质量敏感

3. **成本效益平衡**:
   - 完全人工录入成本高、效率低
   - 完全自动化质量无法保证
   - HITL 在质量和效率之间取得平衡

### 三种模式的设计理由

#### Trace Mode（拓扑修复）

**为什么需要**:
- 2D 拓扑连接关系是后续 3D 生成的基础
- AI 识别可能产生拓扑错误（如墙体未闭合）
- 需要人工在 Canvas 中直观地修复

**设计要点**:
- 使用 D3.js 可视化拓扑图
- 支持拖拽节点调整位置
- 实时更新 CONNECTED_TO 关系

#### Lift Mode（Z轴设置）

**为什么需要**:
- 2D 图纸通常不包含 Z 轴信息
- 需要根据楼层信息和工程经验设置
- 批量操作提高效率

**设计要点**:
- 支持批量选择构件
- 提供楼层模板快速设置
- 支持手动微调

#### Classify Mode（构件归类）

**为什么需要**:
- AI 识别结果可能没有正确的 item_id
- 需要人工将构件归类到 GB50300 层级结构
- 支持拖拽操作，交互直观

**设计要点**:
- 层级树可视化
- 拖拽操作映射到图关系创建
- 支持批量归类

### 与其他方案的比较

#### vs 完全自动化

| 特性 | HITL | 完全自动化 |
|------|------|-----------|
| 数据质量 | ⭐⭐⭐⭐⭐ 高 | ⭐⭐⭐ 中等 |
| 效率 | ⭐⭐⭐⭐ 较高 | ⭐⭐⭐⭐⭐ 最高 |
| 成本 | ⭐⭐⭐⭐ 适中 | ⭐⭐⭐⭐⭐ 最低 |
| 灵活性 | ⭐⭐⭐⭐⭐ 高 | ⭐⭐ 低 |

**选择 HITL**: 数据质量是首要考虑因素。

#### vs 完全人工录入

| 特性 | HITL | 完全人工 |
|------|------|---------|
| 数据质量 | ⭐⭐⭐⭐⭐ 高 | ⭐⭐⭐⭐⭐ 高 |
| 效率 | ⭐⭐⭐⭐ 较高 | ⭐⭐ 低 |
| 成本 | ⭐⭐⭐⭐ 适中 | ⭐ 高 |
| 可扩展性 | ⭐⭐⭐⭐ 好 | ⭐⭐ 差 |

**选择 HITL**: 在保证质量的前提下提高效率。

## 后果

### 正面影响

1. **数据质量高**: 人工参与确保数据准确性
2. **用户体验好**: 三种模式对应不同的任务场景
3. **可扩展性强**: 未来可以添加更多交互模式
4. **成本可控**: 相比完全人工，效率显著提升

### 负面影响

1. **开发复杂度**: 需要实现复杂的 Canvas 交互
2. **性能要求**: 实时更新需要毫秒级响应
3. **用户培训**: 数据工程师需要学习使用工作台

### 需要采取的行动

1. ✅ 设计三种交互模式的 UI/UX
2. ✅ 实现 Canvas 可视化组件
3. ✅ 实现层级树组件
4. ✅ 设计状态机管理逻辑
5. ✅ 实现实时更新机制
6. ⏳ 用户测试和反馈收集
7. ⏳ 用户培训和文档编写

## 参考

- [Human-in-the-Loop Machine Learning](https://www.oreilly.com/library/view/human-in-the-loop/9781492031199/)
- [GB50300 建筑工程施工质量验收统一标准](http://www.mohurd.gov.cn/)
- [IFC Standard Documentation](https://technical.buildingsmart.org/standards/ifc/)

