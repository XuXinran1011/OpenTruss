# OpenTruss UI/UX 详细设计文档

## 1. 设计理念

OpenTruss 采用 **Arch-Tech Precision**（建筑技术精密）设计风格，强调：
- **精确性**: 清晰的数据展示和操作反馈
- **专业性**: 符合工程行业的视觉习惯
- **效率性**: 减少操作步骤，提高工作效率

---

## 2. 整体布局

### 2.1 IDE 式布局

```
┌─────────────────────────────────────────────────────────────┐
│  Top Toolbar (悬浮工具栏)                                      │
├──────────┬──────────────────────────────────────┬────────────┤
│          │                                      │            │
│  Left    │         Canvas (无限画布)            │   Right    │
│  Sidebar │                                      │   Panel    │
│          │                                      │            │
│ (层级树) │                                      │ (参数修正) │
│          │                                      │            │
└──────────┴──────────────────────────────────────┴────────────┘
```

### 2.2 布局说明

- **左侧边栏 (Left Sidebar)**: 宽度 280px，可折叠
  - Hierarchy Tree（层级树）
  - 搜索框
  - 筛选器

- **中间画布 (Canvas)**: 自适应宽度
  - 无限画布（支持缩放、平移）
  - Dot Grid 背景
  - 2D 拓扑可视化

- **右侧面板 (Right Panel)**: 宽度 320px，可折叠
  - 参数修正面板
  - 构件详情
  - 操作按钮

- **顶部工具栏 (Top Toolbar)**: 高度 48px，悬浮
  - 模式切换（Trace/Lift/Classify）
  - 工具按钮
  - 用户信息

---

## 3. 色彩体系

### 3.1 主色调

| 用途 | 颜色 | 色值 | 说明 |
|------|------|------|------|
| Canvas 背景 | White | `#FFFFFF` | 主画布背景 |
| Surface | Zinc 50 | `#FAFAFA` | 侧边栏/面板背景 |
| Action | Zinc 900 | `#18181B` | 主要按钮 |
| Highlight | Orange 600 | `#EA580C` | 3D 升维/强调 |

### 3.2 状态颜色

| 状态 | 颜色 | 色值 | 使用场景 |
|------|------|------|---------|
| Error | Red 600 | `#DC2626` | 必须处理的错误 |
| Z-Missing | Violet 600 | `#9333EA` | 缺失 Z 轴参数（虚线） |
| Warning | Amber 600 | `#D97706` | 建议检查的警告 |
| Verified | Emerald 600 | `#059669` | 已就绪/已验证 |

### 3.3 文本颜色

- **主文本**: `text-zinc-900` (`#18181B`)
- **次要文本**: `text-zinc-600` (`#52525B`)
- **辅助文本**: `text-zinc-400` (`#A1A1AA`)

---

## 4. 字体规范

### 4.1 字体族

- **代码/ID 字体**: `JetBrains Mono`（等宽字体，用于构件 ID、代码显示）
- **UI 字体**: Sans-serif（无衬线字体），如 `Inter`、`Roboto`
- **技术栈**: Next.js, Tailwind CSS (v4), D3.js / Canvas

### 4.2 字号规范

| 用途 | 字号 | 行高 | 字重 |
|------|------|------|------|
| 页面标题 | 24px | 32px | 600 |
| 面板标题 | 18px | 24px | 600 |
| 正文 | 14px | 20px | 400 |
| 辅助文本 | 12px | 16px | 400 |
| 代码/ID | 13px | 18px | 500 (Mono) |

---

## 5. 核心界面组件

### 5.1 Hierarchy Tree (层级树)

**位置**: 左侧边栏

**功能**:
- 展示完整的 GB50300 层级结构
- 支持展开/折叠
- 支持搜索和筛选
- 点击节点定位到画布

**交互**:
- 单击：选中节点，在画布中高亮显示
- 双击：展开/折叠子节点
- 右键：显示上下文菜单

**视觉设计**:
```
Project
  └─ 1#楼
      └─ 主体结构
          └─ 砌体结构
              └─ 填充墙砌体 (25)
                  ├─ 检验批 F1 (10) [IN_PROGRESS]
                  └─ 检验批 F2 (15) [SUBMITTED]
```

**状态指示**:
- 圆点颜色表示检验批状态
- 数字表示构件数量

### 5.1.1 Triage Queue (分诊队列)

**位置**: 左侧边栏顶部（层级树上方）或独立面板

**功能**:
- 按问题严重性分组显示待处理构件
- 快速定位需要优先处理的问题
- 支持批量操作

**优先级排序**:
1. **Topology Error (拓扑错误)**: 最高优先级，红色标识
2. **Z-Missing (缺失高度)**: 中等优先级，紫色标识
3. **Low Confidence (低置信度)**: 较低优先级，黄色标识

**界面设计**:
```
┌─────────────────────────┐
│ 分诊队列 (12)           │
├─────────────────────────┤
│ 🔴 拓扑错误 (5)         │
│   • element_001        │
│   • element_003        │
│   • ...                 │
├─────────────────────────┤
│ 🟣 缺失高度 (4)         │
│   • element_007        │
│   • element_012        │
│   • ...                 │
├─────────────────────────┤
│ 🟠 低置信度 (3)         │
│   • element_020        │
│   • ...                 │
└─────────────────────────┘
```

**交互**:
- 点击问题项：自动定位到画布中的对应构件
- 双击：批量选择该类型的所有问题构件
- 右键：显示批量操作菜单

### 5.2 Canvas (画布)

**位置**: 中间区域

**功能**:
- 2D 拓扑可视化
- 支持缩放（鼠标滚轮）
- 支持平移（拖拽）
- 支持选择（框选/点选）

**背景**:
- 白色背景 (`bg-white`)
- Dot Grid 网格（间距 20px，颜色 `#E4E4E7`）

**构件渲染**:
- **正常状态**: 实线，颜色 `zinc-700`
- **选中状态**: 高亮，颜色 `orange-600`，线宽 2px
- **错误状态**: 红色虚线，颜色 `red-600`
- **Z-Missing**: 紫色虚线，颜色 `violet-600`
- **警告状态**: 黄色虚线，颜色 `amber-600`
- **已验证**: 绿色实线，颜色 `emerald-600`

**交互**:
- **拖拽**: 移动构件节点（Trace Mode）
- **点击**: 选中构件，右侧面板显示详情
- **框选**: 批量选择构件
- **右键**: 显示上下文菜单

### 5.3 Parameter Panel (参数修正面板)

**位置**: 右侧面板

**功能**:
- 显示选中构件的详细信息
- 支持编辑参数
- 批量操作（Lift Mode）

**布局**:
```
┌─────────────────────┐
│ 构件 ID: element_001 │
├─────────────────────┤
│ 类型: Wall          │
│ 状态: Draft         │
├─────────────────────┤
│ Z 轴参数            │
│ ┌─────────────────┐ │
│ │ 高度: [3.0] m   │ │
│ │ 基础偏移: [0.0] │ │
│ └─────────────────┘ │
├─────────────────────┤
│ 材质: [concrete]    │
├─────────────────────┤
│ [保存] [取消]       │
└─────────────────────┘
```

**Lift Mode 特殊界面**:
- 显示批量选择的构件数量
- 统一设置高度和基础偏移
- 预览效果

### 5.4 Top Toolbar (顶部工具栏)

**位置**: 顶部，悬浮

**功能**:
- 模式切换
- 工具按钮
- 用户信息

**布局**:
```
[Trace] [Lift] [Classify]  |  [撤销] [重做]  |  [导出]  |  [用户头像]
```

**模式按钮**:
- **Trace**: 修复 2D 拓扑（默认选中：蓝色背景）
- **Lift**: 批量设置 Z 轴参数
- **Classify**: 拖拽构件归类

---

## 6. 功能模块详细设计

### 6.1 Trace Mode (拓扑修复模式)

**目的**: 修复 AI 识别的 2D 拓扑错误，通过对比原始 DWG 底图确保准确性

**核心功能**:

1. **DWG 底图叠加**
   - 支持加载原始 DWG 施工图作为底图参考层
   - 底图显示在 AI 识别线下方（Z-index 较低）
   - 底图以灰度模式显示，便于区分

2. **透明度滑块 (Opacity Slider)**
   - 位置：顶部工具栏或右侧面板
   - 范围：0-100%
   - 功能：实时调整底图透明度，便于对比 AI 识别结果与原始图纸
   - 默认值：30%（建议值）

3. **X-Ray 模式**
   - 切换按钮：顶部工具栏
   - 功能：同时显示 AI 识别线（彩色）与底图（灰度），直观对比差异
   - AI 识别线：彩色实线/虚线（根据状态）
   - 底图：灰度半透明显示
   - 差异高亮：自动标记识别线与底图差异较大的区域

4. **磁吸操作 (Snap to Grid/Node)**
   - 功能：拖拽构件节点时自动吸附到相邻节点或网格点
   - 吸附距离：可配置（默认 5px）
   - 视觉反馈：吸附时显示磁吸指示线（橙色虚线）
   - 作用：快速修复 2D 拓扑闭合，确保构件连接准确

**交互流程**:
1. 切换到 Trace Mode
2. （可选）加载 DWG 底图
3. 调整底图透明度，启用 X-Ray 模式对比
4. 在画布中选择需要修复的构件
5. 拖拽构件节点，磁吸功能自动吸附到正确位置
6. 系统实时更新拓扑关系（`CONNECTED_TO`）
7. 显示连接预览（虚线）
8. 松开鼠标确认连接

**视觉反馈**:
- 拖拽时显示连接线预览
- 连接有效：绿色虚线
- 连接无效：红色虚线
- 磁吸激活：橙色指示线
- 松开鼠标后确认连接

**快捷键**:
- `T`: 切换到 Trace Mode
- `X`: 切换 X-Ray 模式
- `Delete`: 删除选中的连接
- `[` / `]`: 调整底图透明度（-10% / +10%）

### 6.2 Lift Mode (Z 轴升维模式)

**目的**: 批量设置构件的 Z 轴参数（高度、基础偏移），重点处理缺失高度的构件

**核心功能**:

1. **Z-Missing 识别与高亮**
   - 自动识别：系统自动检测所有缺少 `height` 参数的构件
   - 高亮显示：Z-Missing 构件以紫色虚线显示（`violet-600`）
   - 自动筛选：切换到 Lift Mode 时，自动筛选并高亮显示所有 Z-Missing 构件
   - 数量统计：在 Triage Queue 中显示 Z-Missing 构件数量

2. **参数面板**
   - 位置：右侧面板
   - 功能：提供批量设置界面，支持统一设置 Base Offset 和 Height
   - 实时预览：输入参数时实时预览效果（可选）

**交互流程**:
1. 切换到 Lift Mode
2. 系统自动识别并高亮所有 Z-Missing 构件（紫色虚线）
3. 在画布中框选或点选多个构件（可手动选择，或从 Triage Queue 批量选择）
4. 右侧面板显示批量操作界面
5. 输入高度和基础偏移值
6. 点击"应用"批量更新
7. 更新后，Z-Missing 状态自动清除

**视觉反馈**:
- Z-Missing 构件：紫色虚线高亮显示（`violet-600`）
- 选中的构件：橙色边框（`orange-600`）
- 显示选中数量
- 预览 3D 效果（可选，显示为线框预览）

**批量操作界面**:
```
┌─────────────────────┐
│ 已选择 5 个构件      │
│ (其中 3 个 Z-Missing)│
├─────────────────────┤
│ 统一设置 Z 轴参数    │
│ ┌─────────────────┐ │
│ │ 高度: [3.0] m   │ │
│ │ 基础偏移: [0.0] │ │
│ └─────────────────┘ │
├─────────────────────┤
│ [应用到全部]        │
│ [应用到选中]        │
│ [仅应用到 Z-Missing]│
└─────────────────────┘
```

**快捷键**:
- `L`: 切换到 Lift Mode
- `Ctrl+A`: 全选当前视图中的构件
- `Ctrl+Shift+Z`: 全选所有 Z-Missing 构件

### 6.3 Classify Mode (归类模式)

**目的**: 将构件拖拽归类到正确的分项

**交互流程**:
1. 切换到 Classify Mode
2. 在画布中选择构件（可多选）
3. 拖拽到左侧层级树的目标分项
4. 系统更新构件的 `item_id`

**视觉反馈**:
- 拖拽时显示构件跟随鼠标
- 目标分项高亮显示（绿色背景）
- 无效目标显示红色背景
- 松开鼠标后确认归类

**快捷键**:
- `C`: 切换到 Classify Mode

### 6.4 Inspection Lot Management (检验批管理)

**界面位置**: 独立页面或模态框

**功能**:
- 选择分项工程
- 定义划分规则
- 预览自动聚合结果
- 人工微调

**布局**:
```
┌─────────────────────────────────────┐
│ 检验批策划                           │
├─────────────────────────────────────┤
│ 选择分项: [填充墙砌体 ▼]            │
├─────────────────────────────────────┤
│ 划分规则:                            │
│ ○ 按楼层 (Level)                    │
│ ○ 按区域 (Zone)                     │
│ ○ 自定义规则                        │
├─────────────────────────────────────┤
│ 预览结果:                            │
│ ┌─────────────────────────────────┐ │
│ │ 1#楼F1层填充墙砌体检验批 (25)    │ │
│ │ 1#楼F2层填充墙砌体检验批 (30)    │ │
│ └─────────────────────────────────┘ │
├─────────────────────────────────────┤
│ [创建检验批] [取消]                 │
└─────────────────────────────────────┘
```

---

## 7. 状态可视化

### 7.1 构件状态指示

| 状态 | 视觉表现 | 说明 |
|------|---------|------|
| Draft | 灰色实线 | 数据不完整 |
| Verified | 绿色实线 | 数据完整，已验证 |
| Error | 红色虚线 + 警告图标 | 必须处理的错误 |
| Z-Missing | 紫色虚线 | 缺失 Z 轴参数 |
| Warning | 黄色虚线 | 建议检查的警告 |

### 7.2 检验批状态指示

在层级树中使用圆点颜色表示：

- 🔴 红色：PLANNING
- 🟡 黄色：IN_PROGRESS
- 🔵 蓝色：SUBMITTED
- 🟢 绿色：APPROVED
- ⚫ 黑色：PUBLISHED

---

## 8. 响应式设计

### 8.1 断点定义

- **桌面**: ≥ 1280px（默认布局）
- **平板**: 768px - 1279px（侧边栏可折叠）
- **移动端**: < 768px（单列布局，画布全屏）

### 8.2 移动端适配

- 画布支持触摸手势（缩放、平移）
- 工具栏改为底部固定
- 侧边栏改为抽屉式

---

## 9. 交互细节

### 9.1 加载状态

- **骨架屏**: 数据加载时显示骨架屏
- **进度条**: 批量操作时显示进度条
- **加载动画**: 使用简洁的旋转动画

### 9.2 错误提示

- **Toast 通知**: 操作失败时显示 Toast
- **内联错误**: 表单验证错误显示在输入框下方
- **错误图标**: 使用红色警告图标

### 9.3 确认对话框

- **危险操作**: 删除、驳回等操作需要确认
- **对话框样式**: 简洁的模态框，背景半透明遮罩

---

## 10. 可访问性 (A11y)

### 10.1 键盘导航

- `Tab`: 切换焦点
- `Enter`: 确认操作
- `Esc`: 取消/关闭
- `方向键`: 在层级树中导航

### 10.2 屏幕阅读器支持

- 使用语义化 HTML
- 添加 `aria-label` 属性
- 提供替代文本

---

## 11. 性能优化

### 11.1 渲染优化

- **虚拟滚动**: 层级树使用虚拟滚动
- **Canvas 优化**: 使用 `requestAnimationFrame` 优化动画
- **防抖节流**: 搜索、缩放等操作使用防抖/节流

### 11.2 数据加载

- **懒加载**: 按需加载构件数据
- **分页**: 大量数据使用分页加载
- **缓存**: 缓存常用查询结果

---

*文档版本：1.0*  
*最后更新：根据 PRD v4.0 创建*

