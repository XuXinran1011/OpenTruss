# MEP 路由规划详细规格文档

## 概述

本文档详细说明 MEP（机电设备）路由规划和管线综合排布的完整流程、约束规则和实现要求。

## 权限与流程

### 责任人
- **MEP专业负责人**：负责路由规划和管线综合排布工作
- **总工**：可以设置空间限制，审核路由规划结果

### 工作流程

1. **MEP元素完整性验证** → 验证通过后提交至MEP专业负责人
2. **路由规划阶段**（2D Trace Mode） → MEP专业负责人完成路由规划
3. **管线综合排布阶段**（3D空间） → MEP专业负责人完成管线综合排布
4. **审批通过** → 确认完成后生成穿墙/穿楼板节点

### 状态标识

在完成管线综合排布前，系统显示"未完成管线综合排布"，**不进行碰撞报警**。所有碰撞（包括MEP元素之间、MEP与建筑结构）统一在管线综合排布阶段解决。

## 路由规划阶段（2D Trace Mode）

### 总体目标

在2D平面视图下进行水平MEP管线的路径规划，找出符合约束条件的最短路由。

### 竖向管线处理

- **不参与自动路由规划**：竖向管线（Z方向变化>1米）由MEP专业负责人手动调整位置
- **手动调整**：MEP专业负责人可以手动设置竖向管线的位置
- **综合排布考虑**：竖向管线在管线综合排布阶段要尽量贴近附近的墙、柱，避免与其他竖向管线和水平管线的连接处碰撞

### 水平管线约束

#### 1. 必须穿过楼层内空间

水平管线必须穿过楼层内的空间（`Space`元素，定义在 `backend/app/models/speckle/spatial.py`）。系统会验证路由路径是否经过有效的空间。

**Space 和 Room 的概念区别**：
- **Space（空间）**：MEP空间元素，包含房间空间和公共空间（如走廊、大厅等）
- **Room（房间）**：具体的房间元素，通过 `Space.room_id` 字段关联到Room
- **关联关系**：如果 `Space.room_id` 存在，则该Space关联到一个具体的Room；如果为None，则为非房间空间（走廊、大厅等公共空间）

#### 2. 端点固定约束

水平管线的端点（包括风口、接口等）**不能通过自动路由规划调整**。只有路径的中间部分可以被规划算法调整。

#### 3. 最短路由目标

自动路由规划的目标是找出**符合约束条件的最短路由**。约束条件包括：
- 必须穿过指定的空间
- 不能经过禁止穿过的空间
- 符合系统类型特定的角度约束（如重力排水禁止90°）
- 满足转弯半径要求

#### 4. 原始路由约束

**重要说明**：原始路由约束**仅针对Room（房间）**，而非Space（空间）。

自动规划的新路由**不能经过原始路由未经过的房间**。原始路由定义为导入时的初始几何路径（从源元素到目标元素的初始路径）。

**Room 和 Space 的约束区别**：

1. **Room（房间）约束**：
   - 如果原始路由经过房间A、B、C，新路由只能经过A、B、C的子集或全部
   - 如果原始路由未经过房间D，新路由不能经过房间D
   - 房间通过 `Space.room_id` 字段识别：如果 `Space.room_id` 存在，则该Space关联到一个Room，受原始路由约束限制

2. **非房间Space（走廊、大厅等）**：
   - 如果 `Space.room_id` 为None（走廊、大厅等公共空间），即使原始路由未经过，也可以作为更短路由使用
   - 这些空间不受原始路由约束限制，允许系统优化路由时选择更短的路径

3. **空间限制设置**（适用于所有Space）：
   - 所有Space（无论是否关联Room）都受 `forbid_horizontal_mep`/`forbid_vertical_mep` 设置限制
   - 如果Space被设置为禁止MEP穿过，该Space将作为障碍物处理

**约束验证逻辑**：
- 查询路径经过的所有Space
- 对于每个Space：
  - 如果 `Space.room_id` 存在且不在原始路由经过的Room ID列表中 → 违反约束（不能穿过）
  - 如果 `Space.room_id` 为None → 允许通过（不受原始路由约束限制，可用于优化路由）
  - 检查 `Space.forbid_horizontal_mep` 设置（如果为True，则禁止通过）

#### 5. 空间限制设置

MEP专业负责人和总工可以设置空间禁止MEP管线穿过：

- `forbid_horizontal_mep: bool` - 禁止水平MEP穿过此空间
- `forbid_vertical_mep: bool` - 禁止竖向MEP穿过此空间

这些设置会影响路由规划算法，被禁止的空间将作为障碍物处理。

#### 6. 分步路由规划

MEP专业负责人可以选择按以下方式分步进行路由规划（可选组合）：

- **按分项**：按GB50300分项工程（如给排水、通风空调、电气）
- **按系统**：按MEP系统类型（如gravity_drainage、pressure_water）
- **按规格区间**：按管线规格区间（如管径范围、截面积范围）

这三种筛选方式可以单独使用，也可以组合使用。例如：可以只规划"给排水"分项下的"重力排水"系统中"管径50-150mm"的管道。

#### 7. 预览确认机制

点击"自动规划路由"后：
- 系统计算新的路由路径
- 新路由以**虚线/半透明**方式显示在Canvas上
- 原始路由保持正常显示
- 用户可以比较新旧路由
- 用户选择确认后，系统应用新路由
- 用户可以选择取消，保留原始路由

#### 8. 完成路由规划

MEP专业负责人完成路由规划后，可以点击"确认结束路由规划"，进入管线综合排布阶段。

### 路由规划算法约束

#### 坡度约束（仅管道）

- **坡度属性**：Pipe模型包含 `slope: Optional[float]` 字段（百分比%）
- **重力流管道**：必须 `slope > 0`（不能倒坡）
- **坡度验证**：在路由规划时验证重力流管道的坡度是否符合要求

#### 角度约束

根据系统类型和元素类型，有不同的角度约束：

- **重力排水系统**：禁止90°弯头，使用双45°路径点模式
- **压力给水系统**：允许45°、90°、180°
- **风管系统**：允许45°、90°、180°
- **电缆桥架**：允许45°、90°、180°，但使用宽度约束而非圆弧弯头

详细约束定义在 `backend/app/config/rules/mep_routing_config.json` 中。

#### 转弯半径约束

- **管道**：根据管径和配置的 `bend_radius_ratio` 计算最小转弯半径
- **风管**：根据宽度/高度和配置的 `bend_radius_ratio` 计算最小转弯半径
- **电缆桥架**：使用宽度约束，确保电缆转弯半径可通过

## 管线综合排布阶段（3D空间）

### 总体目标

在3D空间中进行管线综合排布，解决所有碰撞问题，优化管线布局。

### 操作约束

管线综合排布只通过以下方式调整：
1. **小范围内水平平移**局部管线
2. **小范围内垂直平移**局部管线
3. **增加翻弯**避开梁、柱及其他管线

**不允许**：大幅修改路由路径、改变路由经过的空间。

### 目标优先级

管线综合排布的目标优先级（从高到低）：

1. **避开碰撞**（最高优先级）
   - MEP元素之间的碰撞
   - MEP与建筑结构的碰撞（梁、柱、墙、楼板）
   - **梁、柱碰撞是最高优先级解决项**

2. **尽量贴近楼层顶板**
   - 在避开碰撞的前提下，尽量将管线贴近本楼层顶板
   - 节省垂直空间，提高空间利用率

3. **少翻弯**
   - 在满足前两个目标的前提下，尽量减少翻弯次数
   - 降低施工难度和成本

### 竖向管线处理

- **贴近墙、柱**：竖向管线要尽量贴近附近的墙、柱
- **避免连接处碰撞**：避免与其他竖向管线和水平管线的连接处碰撞

### 状态转换

- **可以退回路由规划**：在管线综合排布过程中，MEP专业负责人可以随时退回2D路由规划阶段，重新进行路由规划
- **确认完成**：完成管线综合排布后，点击确认通过审批，系统生成穿墙/穿楼板节点

## 碰撞处理规则

### 碰撞类型

1. **MEP元素之间的碰撞**
   - 管道与管道
   - 管道与风管
   - 管道与桥架
   - 风管与桥架
   - 等等

2. **MEP与建筑结构的碰撞**
   - MEP与梁的碰撞（最高优先级）
   - MEP与柱的碰撞（最高优先级）
   - MEP与墙的碰撞
   - MEP与楼板的碰撞

### 碰撞处理时机

- **路由规划阶段**：不进行碰撞检测和报警，只显示"未完成管线综合排布"
- **管线综合排布阶段**：统一解决所有碰撞问题
- **梁、柱碰撞**：是最高优先级解决项，必须优先处理

### 避障优先级系统

系统使用5级默认优先级（详见 [MEP_SYSTEM_PRIORITY.md](./MEP_SYSTEM_PRIORITY.md)）：

1. 重力流管道（最高优先级）
2. 大截面风管
3. 大口径有压管道
4. 电缆桥架
5. 小口径有压管道及电线导管（最低优先级）

**优先级冲突处理**（相同优先级时）：
1. 少翻弯（优先）
2. 较小管径/截面积避让较大管径/截面积
3. 尽量贴近本楼层顶板

## MEP与建筑结构的关系

### 梁、柱

- **默认避让**：MEP管线默认避让梁、柱
- **手动调整**：MEP专业负责人可以手动调整，经确认后可穿过（如预留孔洞）
- **碰撞优先级**：与梁、柱的碰撞是最高优先级解决项

### 楼板、墙体

#### 有防火要求的楼板、内墙

- **防火封堵**：需要设置同防火等级的防火封堵节点
- **生成时机**：完成管线综合排布确认通过审批时生成节点

#### 有防水要求的楼板、墙体

- **防水套管**：
  - 重力流管道、有压管道：默认刚性防水套管（用户可手动改为柔性）
  - 风管、桥架穿楼板：设置挡水台
- **生成时机**：完成管线综合排布确认通过审批时生成节点

#### 无防火/防水要求的墙、楼板

- **一般套管**：
  - 无防火/防水要求的墙：设置一般穿墙套管
  - 无防火/防水要求的楼板：设置一般穿楼板套管
- **生成时机**：完成管线综合排布确认通过审批时生成节点

详细规则见 [MEP_PENETRATION.md](./MEP_PENETRATION.md)。

## 管道配件和附件考虑

### 管道附着物

计算管径/截面尺寸时要考虑：
- 保温层
- 隔音层
- 保护层
- 防火包裹

这些附着物的厚度需要添加到管道的实际尺寸中，用于碰撞检测和空间占用计算。

### 管道配件附件

- **阀门手柄/执行机构**：占据的空间需要预留
- **检修口/检修门**：日常维护操作方向上要预留空间
- **默认检修空间**：管道周边预留默认5cm的检修操作空间（可在配置文件中自定义）

详细配置见 `backend/app/config/rules/mep_routing_config.json` 中的 `maintenance_space` 部分。

## 相关文档

- [MEP_ROUTING.md](./MEP_ROUTING.md) - MEP路由规划系统概述
- [MEP_COORDINATION.md](./MEP_COORDINATION.md) - 管线综合排布详细规格
- [MEP_SYSTEM_PRIORITY.md](./MEP_SYSTEM_PRIORITY.md) - MEP系统优先级配置
- [MEP_PENETRATION.md](./MEP_PENETRATION.md) - 穿墙/穿楼板节点生成规则
- [API 文档](../api/index.md) - API接口文档
- [规则引擎文档](../rules/RULE_ENGINE.md) - 规则引擎文档

