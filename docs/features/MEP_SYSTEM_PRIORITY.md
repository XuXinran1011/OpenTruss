# MEP 系统优先级配置文档

## 概述

MEP系统优先级配置定义了在管线综合排布阶段，不同MEP系统之间的避让优先级。当多个系统发生碰撞时，优先级低的系统需要避让优先级高的系统。

## 默认优先级配置（5级系统）

系统提供5级默认优先级配置，定义在 `backend/app/config/rules/mep_routing_config.json` 中。

### 优先级1：重力流管道（最高优先级）

**系统类型**：
- `gravity_drainage` - 重力排水
- `gravity_rainwater` - 重力雨水
- `condensate` - 冷凝水

**约束规则**：
- **优先规划最短路由**：重力流管道必须保持最短路径，减少流动阻力
- **不能倒坡**：必须 `slope > 0`（向下倾斜），坡度单位使用百分比%
- **不能上下翻弯**：重力流管道不能进行垂直方向的翻弯，只能水平路由
- **严重影响功能**：违反这些约束会严重影响管道功能，导致排水不畅

**避让原则**：其他所有系统必须避让重力流管道。

### 优先级2：大截面风管（第二优先级）

**系统类型**：
- `smoke_exhaust` - 防排烟
- `air_conditioning` - 空调风
- `fresh_air` - 新风
- `supply_exhaust` - 送排风

**约束规则**：
- **次优先规划路由**：在重力流管道之后规划
- **翻弯困难**：大截面风管翻弯需要较大的空间
- **成本高**：翻弯会增加材料成本和施工难度
- **弯头占据空间大**：风管弯头需要较大的空间
- **影响功能**：翻弯会影响风道性能

**避让原则**：避让重力流管道，但优先于有压管道、电缆桥架和小口径管道。

### 优先级3：大口径有压管道（第三优先级）

**系统类型**：
- `fire_suppression` - 消防（主干）
- `water_supply` - 给水（主干）
- `chilled_water` - 冷冻水（主干）
- `cooling_water` - 冷却水（主干）
- `hot_water` - 生活热水（主干）
- `heating_main` - 供暖（主干管道）

**约束规则**：
- **第三优先规划路由**：在重力流管道和大截面风管之后规划
- **弯头占据空间较大**：大口径管道的弯头需要较大的空间

**避让原则**：避让重力流管道和大截面风管，但优先于电缆桥架和小口径管道。

### 优先级4：电缆桥架（第四优先级）

**系统类型**：
- `power_cable` - 强电桥架
- `weak_cable` - 弱电桥架

**约束规则**：
- **第四优先级规划路由**：在管道和风管之后规划
- **翻弯占据空间小**：电缆桥架翻弯相对容易，占据空间较小
- **成本稍高**：翻弯会增加一定成本

**避让原则**：避让所有管道和风管系统，但优先于小口径有压管道和电线导管。

### 优先级5：小口径有压管道及电线导管（最低优先级）

**系统类型**：
- `fire_suppression_branch` - 消防（支管）
- `water_supply_branch` - 给水（支管）
- `chilled_water_branch` - 冷冻水（支管）
- `hot_water_branch` - 生活热水（支管）
- `heating_branch` - 供暖（支管）
- `conduit` - 电线导管

**约束规则**：
- **最后规划路由**：在所有其他系统之后规划
- **翻弯占据空间小**：小口径管道和导管翻弯容易，占据空间小
- **成本较低**：翻弯成本相对较低

**避让原则**：避让所有其他系统。

## 附加考虑因素

### 管道附着物

在计算碰撞检测和空间占用时，需要考虑管道附着物：

- **保温层**：增加管道外径
- **隔音层**：增加管道外径
- **保护层**：增加管道外径
- **防火包裹**：增加管道外径

这些附着物的厚度需要添加到管道的实际尺寸中。配置可在 `backend/app/config/rules/mep_routing_config.json` 中定义。

### 管道配件附件空间

在碰撞检测和空间预留时，需要考虑管道配件附件：

1. **阀门手柄/执行机构**：
   - 占据的空间需要预留
   - 操作方向上需要足够的空间
   - 不同类型阀门的空间要求不同

2. **检修口/检修门**：
   - 日常维护操作方向上要预留空间
   - 需要考虑检修人员的操作空间

3. **默认检修空间**：
   - 管道周边预留默认5cm的检修操作空间
   - 可在配置文件中自定义全局默认值和按元素类型的覆盖值

配置定义在 `backend/app/config/rules/mep_routing_config.json` 的 `maintenance_space` 部分。

## 优先级冲突处理

### 相同优先级时的处理规则

当两个系统具有相同的优先级时，按以下顺序处理（从优先到次优）：

1. **少翻弯**（优先）
   - 优先选择翻弯次数少的方案
   - 降低施工难度和成本

2. **较小管径/截面积避让较大管径/截面积**
   - 小管径系统避让大管径系统
   - 减少大管径系统翻弯的空间需求

3. **尽量贴近本楼层顶板**
   - 在满足前两个条件的前提下，尽量将管线贴近顶板
   - 提高空间利用率

### 配置

优先级冲突处理规则定义在 `backend/app/config/rules/mep_routing_config.json` 的 `system_priority.conflict_resolution` 部分。

## 用户自定义优先级配置

### 配置方式

MEP专业负责人可以按以下维度调整优先级划分：

1. **按子分部**：按GB50300子分部工程调整优先级
2. **按管线材质**：按管线材质（如不锈钢、PPR、PVC）调整优先级
3. **按规格区间**：按管线规格区间（如管径范围、截面积范围）调整优先级

### 配置界面设计

**配置界面应提供**：
- 显示当前优先级配置（5级系统）
- 允许调整系统类型的优先级级别
- 支持按子分部/材质/规格区间筛选系统
- 保存自定义配置（按项目或按用户）
- 恢复默认配置

### 配置存储

- **项目级配置**：保存在项目配置中，影响整个项目的路由规划
- **用户级配置**：保存在用户配置中，作为默认配置
- **系统默认配置**：定义在 `mep_routing_config.json` 中

## 配置文件结构

优先级配置定义在 `backend/app/config/rules/mep_routing_config.json` 中：

```json
{
  "system_priority": {
    "default_priority_levels": [
      {
        "level": 1,
        "name": "重力流管道",
        "systems": ["gravity_drainage", "gravity_rainwater", "condensate"],
        "constraints": {
          "priority_rules": "优先规划最短路由，不能倒坡，不能上下翻弯"
        }
      },
      // ... 其他级别
    ],
    "conflict_resolution": {
      "same_priority_order": [
        "少翻弯",
        "较小管径/截面积避让较大管径/截面积",
        "尽量贴近本楼层顶板"
      ]
    }
  }
}
```

## 相关文档

- [MEP_ROUTING_DETAILED.md](./MEP_ROUTING_DETAILED.md) - MEP路由规划详细规格
- [MEP_COORDINATION.md](./MEP_COORDINATION.md) - 管线综合排布规格
- [API 文档](../api/index.md) - API接口文档（优先级配置API）
- [规则引擎文档](../rules/RULE_ENGINE.md) - 规则引擎文档

