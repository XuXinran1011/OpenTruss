# 管线综合排布规格文档

## 概述

管线综合排布是在3D空间中进行MEP管线布局优化的阶段，目标是解决所有碰撞问题，优化管线布局，提高空间利用率和施工便利性。

## 阶段定位

- **前置阶段**：2D路由规划（Trace Mode）必须完成
- **本阶段**：3D管线综合排布（Coordination Mode）
- **后续阶段**：审批通过后生成穿墙/穿楼板节点

### 阶段转换

- **进入条件**：2D路由规划完成后，MEP专业负责人点击"确认结束路由规划"
- **退回机制**：3D管线综合排布过程中可以随时退回2D路由规划阶段
- **完成条件**：所有碰撞消除后，MEP专业负责人点击"确认完成管线综合排布"

## 操作约束

### 允许的操作

管线综合排布只允许通过以下方式进行局部调整：

1. **小范围内水平平移**局部管线段
2. **小范围内垂直平移**局部管线段
3. **增加翻弯**避开障碍物（梁、柱、其他管线）

### 不允许的操作

- **大幅修改路由路径**：不能改变路由的基本走向
- **改变路由经过的空间**：不能使管线进入原始路由未经过的房间
- **删除或新增主要路由段**：只能进行局部微调

## 目标与优先级

### 目标优先级（从高到低）

#### 1. 避开碰撞（最高优先级）

**碰撞类型**：
- **MEP元素之间的碰撞**：
  - 管道与管道
  - 管道与风管
  - 管道与电缆桥架
  - 风管与电缆桥架
  - 等等

- **MEP与建筑结构的碰撞**：
  - MEP与梁的碰撞（**最高优先级解决项**）
  - MEP与柱的碰撞（**最高优先级解决项**）
  - MEP与墙的碰撞
  - MEP与楼板的碰撞

**碰撞处理原则**：
- 梁、柱碰撞必须优先解决
- 其他碰撞按照避障优先级系统处理（见 [MEP_SYSTEM_PRIORITY.md](./MEP_SYSTEM_PRIORITY.md)）

#### 2. 尽量贴近楼层顶板

在避开所有碰撞的前提下：
- 尽量将管线贴近本楼层顶板
- 节省垂直空间
- 提高空间利用率

#### 3. 少翻弯

在满足前两个目标的前提下：
- 尽量减少翻弯次数
- 降低施工难度
- 降低成本

## 避障优先级系统

### 默认5级优先级

系统使用5级默认优先级（详细说明见 [MEP_SYSTEM_PRIORITY.md](./MEP_SYSTEM_PRIORITY.md)）：

1. **重力流管道**（最高优先级）
   - 重力排水、重力雨水、冷凝水等
   - 约束：不能倒坡，不能上下翻弯，严重影响功能

2. **大截面风管**（第二优先级）
   - 防排烟、空调风、新风、送排风等
   - 约束：翻弯困难，成本高，弯头占据空间大，影响功能

3. **大口径有压管道**（第三优先级）
   - 消防、给水、冷冻水、冷却水、生活热水、供暖主干管道等
   - 约束：弯头占据空间较大

4. **电缆桥架**（第四优先级）
   - 强电桥架、弱电桥架等
   - 约束：翻弯占据空间小，成本稍高

5. **小口径有压管道及电线导管**（最低优先级）
   - 消防、给水、冷冻水、生活热水、供暖支管
   - 约束：翻弯占据空间小，成本较低

### 优先级冲突处理

当两个系统具有相同优先级时，按以下顺序处理：

1. **少翻弯**（优先）
2. **较小管径/截面积避让较大管径/截面积**
3. **尽量贴近本楼层顶板**

## 竖向管线处理

### 竖向管线判定

- **判定标准**：Z方向变化>1米判定为竖向管线
- **配置**：阈值可在 `backend/app/config/rules/mep_routing_config.json` 中配置

### 竖向管线约束

在管线综合排布阶段：

1. **贴近墙、柱**：竖向管线要尽量贴近附近的墙、柱
   - 节省空间
   - 便于固定和支撑

2. **避免连接处碰撞**：
   - 避免与其他竖向管线的连接处碰撞
   - 避免与水平管线的连接处碰撞
   - 连接处需要预留足够的操作空间

## 翻弯规则

### 翻弯的目的

翻弯用于避开障碍物（梁、柱、其他管线），在垂直方向上调整管线位置。

### 翻弯约束

1. **翻弯角度**：根据系统类型和元素类型，有特定的角度约束
   - 重力流管道：禁止上下翻弯（只能水平路由）
   - 有压管道：可以使用45°、90°翻弯
   - 风管：可以使用45°、90°翻弯（但大截面风管翻弯困难）
   - 电缆桥架：可以使用45°、90°翻弯

2. **翻弯半径**：
   - 管道：根据管径和配置的 `bend_radius_ratio` 计算最小转弯半径
   - 风管：根据宽度/高度和配置的 `bend_radius_ratio` 计算最小转弯半径
   - 电缆桥架：使用宽度约束

3. **翻弯位置**：
   - 优先在管线中部翻弯，避免在连接处翻弯
   - 考虑检修和维护的便利性

## 贴近顶板规则

### 目标

在避开碰撞的前提下，尽量将管线贴近本楼层顶板。

### 实现方式

1. **垂直平移**：将管线垂直向上平移，贴近顶板
2. **考虑因素**：
   - 顶板高度（从Space模型的 `top_level` 和 `top_offset` 获取）
   - 吊顶高度（如果有）
   - 检修空间要求
   - 管道附件（阀门手柄等）的操作空间

### 约束

- 不能与其他管线或结构碰撞
- 必须满足检修空间要求（默认5cm，可配置）
- 考虑管道附件（阀门手柄、执行机构）的操作空间

## 碰撞检测规则

### 碰撞检测范围

1. **MEP元素之间的碰撞**：
   - 检测所有MEP元素（管道、风管、电缆桥架、导管、电线）之间的空间重叠

2. **MEP与建筑结构的碰撞**：
   - MEP与梁的碰撞（最高优先级）
   - MEP与柱的碰撞（最高优先级）
   - MEP与墙的碰撞
   - MEP与楼板的碰撞

### 碰撞检测考虑因素

1. **管道实际尺寸**：
   - 管道外径 + 保温层厚度
   - 管道外径 + 隔音层厚度
   - 管道外径 + 保护层厚度
   - 管道外径 + 防火包裹厚度

2. **管道附件空间**：
   - 阀门手柄占据的空间
   - 执行机构占据的空间
   - 检修口/检修门的操作空间
   - 默认检修空间（5cm，可配置）

3. **最小间距**：
   - 不同系统之间的最小间距（可在配置中定义）
   - 考虑施工和维护的便利性

### 碰撞检测算法

1. **3D空间碰撞检测**：
   - 使用3D几何计算检测管线与障碍物的空间重叠
   - 考虑管线的实际尺寸（包括保温层等）

2. **优先级处理**：
   - 按照避障优先级系统确定哪个系统避让
   - 梁、柱碰撞优先处理

3. **冲突解决**：
   - 使用优先级冲突处理规则（少翻弯 > 较小管径避让较大管径 > 贴近顶板）
   - 生成避让建议（水平平移、垂直平移、增加翻弯）

## 状态管理

### 状态标识

- **路由规划阶段**：显示"进行路由规划"
- **管线综合排布阶段**：显示"进行管线综合排布"
- **未完成状态**：显示"未完成管线综合排布"（在完成前不进行碰撞报警）

### 完成条件

所有碰撞消除后，MEP专业负责人可以点击"确认完成管线综合排布"，系统将：
1. 验证所有碰撞已解决
2. 验证所有约束已满足
3. 进入审批流程
4. 审批通过后生成穿墙/穿楼板节点（见 [MEP_PENETRATION.md](./MEP_PENETRATION.md)）

## 相关文档

- [MEP_ROUTING_DETAILED.md](./MEP_ROUTING_DETAILED.md) - MEP路由规划详细规格
- [MEP_SYSTEM_PRIORITY.md](./MEP_SYSTEM_PRIORITY.md) - MEP系统优先级配置
- [MEP_PENETRATION.md](./MEP_PENETRATION.md) - 穿墙/穿楼板节点生成规则
- [API.md](./API.md) - API接口文档
- [RULE_ENGINE.md](./RULE_ENGINE.md) - 规则引擎文档

