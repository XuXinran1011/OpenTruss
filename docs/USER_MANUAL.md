# OpenTruss 用户手册

## 1. 系统概述

OpenTruss 是一个面向建筑施工行业的生成式 BIM 中间件，帮助工程师将 CAD 图纸转换为符合 GB50300 国标的 BIM 模型。

### 1.1 核心功能

- **数据摄入**: 接收 AI 识别的构件数据
- **数据清洗**: 修复拓扑错误，补全参数
- **检验批管理**: 按规则自动创建检验批
- **审批工作流**: 检验批审批和验收
- **IFC 导出**: 生成标准 IFC 模型

### 1.2 用户角色

- **Editor (分部工程师)**: 数据清洗和参数补全
- **Approver (专业负责人/总工)**: 规则定义和审批
- **PM (项目经理)**: 进度监控和熔断

---

## 2. 快速开始

### 2.1 登录系统

1. 访问系统地址
2. 输入用户名和密码
3. 点击"登录"

### 2.2 界面介绍

系统采用 IDE 式布局：

- **左侧边栏**: 层级树，显示项目结构
- **中间画布**: 2D 拓扑可视化
- **右侧面板**: 参数修正面板
- **顶部工具栏**: 模式切换和工具按钮

---

## 3. Editor 操作指南

### 3.1 数据清洗工作流

#### 步骤 1: 查看未分配构件

1. 在左侧层级树中找到 "Unassigned Item"
2. 点击展开，查看未分配的构件列表
3. 构件以灰色虚线显示，表示数据不完整

#### 步骤 2: Trace Mode - 修复拓扑

1. 点击顶部工具栏的 **Trace** 按钮
2. 在画布中选择需要修复的构件
3. 拖拽构件节点，调整位置
4. 系统会自动更新拓扑连接关系
5. 绿色虚线表示有效连接，红色表示无效

**快捷键**: `T` 切换到 Trace Mode

#### 步骤 3: Lift Mode - 设置 Z 轴参数

1. 点击顶部工具栏的 **Lift** 按钮
2. 在画布中框选或点选多个构件
3. 右侧面板显示批量操作界面
4. 输入高度和基础偏移值
5. 点击"应用到全部"批量更新

**快捷键**: `L` 切换到 Lift Mode

**注意事项**:
- 高度单位为米 (m)
- 基础偏移可以是负数（表示下沉）

#### 步骤 4: Classify Mode - 归类构件

1. 点击顶部工具栏的 **Classify** 按钮
2. 在画布中选择构件（可多选）
3. 拖拽到左侧层级树的目标分项
4. 松开鼠标完成归类

**快捷键**: `C` 切换到 Classify Mode

### 3.2 提交检验批审批

1. 在左侧层级树中选择检验批
2. 确认所有构件状态为 "Verified"（绿色）
3. 点击右侧面板的"提交审批"按钮
4. 系统会验证构件完整性
5. 验证通过后，检验批状态变为 "SUBMITTED"

**常见问题**:
- **验证失败**: 检查是否有构件缺少高度、材质或拓扑不闭合
- **状态未更新**: 刷新页面或重新选择检验批

---

## 4. Approver 操作指南

### 4.1 创建检验批策略

#### 步骤 1: 选择分项

1. 导航到"检验批管理"页面
2. 在"选择分项"下拉框中选择分项（如：填充墙砌体）

#### 步骤 2: 定义划分规则

选择划分方式：

- **按楼层 (Level)**: 每个楼层创建一个检验批
- **按区域 (Zone)**: 每个区域创建一个检验批
- **自定义规则**: 手动定义规则（高级功能）

#### 步骤 3: 预览结果

系统会显示预览，列出将创建的检验批：

```
1#楼F1层填充墙砌体检验批 (25 个构件)
1#楼F2层填充墙砌体检验批 (30 个构件)
1#楼F3层填充墙砌体检验批 (28 个构件)
```

#### 步骤 4: 创建检验批

1. 确认预览结果正确
2. 点击"创建检验批"按钮
3. 系统自动创建检验批并关联构件

### 4.2 人工微调

创建检验批后，可以手动调整：

1. 选择检验批
2. 在构件列表中，点击"添加构件"或"移除构件"
3. 选择目标构件
4. 确认操作

### 4.3 审批检验批

#### 审批通过

1. 在"待审批"列表中选择检验批
2. 查看构件详情和完整性
3. 点击"审批通过"按钮
4. 输入审批意见（可选）
5. 确认审批

#### 驳回

1. 选择需要驳回的检验批
2. 点击"驳回"按钮
3. 选择驳回级别：
   - **IN_PROGRESS**: 需要修正数据
   - **PLANNING**: 需要重新规划
4. 输入驳回原因
5. 确认驳回

---

## 5. PM 操作指南

### 5.1 监控验收进度

1. 登录系统，进入"监控面板"
2. 查看各分部的验收进度：
   - 总检验批数
   - 已验收数量
   - 验收进度百分比
3. 点击分部查看详细信息

### 5.2 查看检验批状态

在监控面板中，可以按状态筛选：

- **PLANNING**: 规划中（红色）
- **IN_PROGRESS**: 清洗中（黄色）
- **SUBMITTED**: 待审批（蓝色）
- **APPROVED**: 已验收（绿色）
- **PUBLISHED**: 已发布（黑色）

### 5.3 一键驳回（熔断机制）

当发现严重问题时，PM 可以执行一键驳回：

1. 选择需要驳回的检验批或楼层
2. 点击"一键驳回"按钮
3. 选择驳回级别：
   - **IN_PROGRESS**: 退回数据清洗阶段
   - **PLANNING**: 退回规划阶段（严重问题）
4. 输入驳回原因
5. 确认操作

**注意**: 一键驳回会影响所有相关检验批，请谨慎操作。

---

## 6. HITL Workbench 使用教程

### 6.1 界面布局

```
┌─────────────────────────────────────────────────────────────┐
│  [Trace] [Lift] [Classify]  |  [撤销] [重做]  |  [导出]     │
├──────────┬──────────────────────────────────────┬────────────┤
│          │                                      │            │
│ 层级树    │          Canvas (画布)                │  参数面板   │
│          │                                      │            │
│ Project  │                                      │ 构件详情   │
│  └─ 1#楼 │                                      │            │
│      └─  │                                      │ 高度: [3.0] │
│          │                                      │ 材质: [...] │
└──────────┴──────────────────────────────────────┴────────────┘
```

### 6.2 画布操作

#### 缩放和平移

- **缩放**: 鼠标滚轮向上/向下
- **平移**: 按住鼠标中键拖拽，或使用方向键
- **重置视图**: 双击画布空白处

#### 选择构件

- **单选**: 点击构件
- **多选**: 按住 `Ctrl` 键点击，或框选
- **全选**: `Ctrl+A`

#### 构件状态颜色

- **灰色实线**: Draft（草稿）
- **绿色实线**: Verified（已验证）
- **红色虚线**: Error（错误，必须处理）
- **紫色虚线**: Z-Missing（缺失 Z 轴参数）
- **黄色虚线**: Warning（警告，建议检查）

### 6.3 参数修正面板

选中构件后，右侧面板显示：

- **构件 ID**: 唯一标识符
- **类型**: 构件类型（Wall、Column 等）
- **状态**: Draft 或 Verified
- **Z 轴参数**: 高度和基础偏移
- **材质**: 材质选择
- **操作按钮**: 保存、取消

---

## 7. 常见问题 FAQ

### 7.1 数据清洗相关问题

**Q: 如何知道哪些构件需要处理？**

A: 查看构件状态颜色：
- 红色虚线：必须处理的错误
- 紫色虚线：缺失 Z 轴参数
- 黄色虚线：建议检查的警告

**Q: 批量设置 Z 轴时，如何只更新部分构件？**

A: 使用"应用到选中"按钮，而不是"应用到全部"。

**Q: 拓扑连接错误如何修复？**

A: 切换到 Trace Mode，拖拽构件节点调整位置，系统会自动更新连接关系。

### 7.2 检验批相关问题

**Q: 创建检验批后，可以修改吗？**

A: 在 PLANNING 和 IN_PROGRESS 状态下可以修改，SUBMITTED 后需要驳回才能修改。

**Q: 如何知道检验批是否可以提交？**

A: 检查所有构件状态是否为 Verified（绿色），系统会在提交时自动验证。

**Q: 检验批被驳回后怎么办？**

A: 根据驳回原因修正数据，然后重新提交。

### 7.3 审批相关问题

**Q: 审批时需要注意什么？**

A: 检查构件完整性、几何数据正确性、是否符合验收标准。

**Q: 可以批量审批吗？**

A: 目前不支持批量审批，需要逐个审批。

**Q: 审批通过后可以撤销吗？**

A: 可以，但需要 PM 权限执行一键驳回。

### 7.4 导出相关问题

**Q: 如何导出 IFC 模型？**

A: 选择 APPROVED 状态的检验批，点击"导出 IFC"按钮。

**Q: 导出的 IFC 文件可以在 Revit 中打开吗？**

A: 可以，导出的 IFC 文件符合 IFC 标准，可以在 Revit、Navisworks 等软件中打开。

**Q: 导出失败怎么办？**

A: 检查检验批状态是否为 APPROVED，检查构件数据是否完整。

---

## 8. 快捷键参考

| 快捷键 | 功能 |
|-------|------|
| `T` | 切换到 Trace Mode |
| `L` | 切换到 Lift Mode |
| `C` | 切换到 Classify Mode |
| `Ctrl+A` | 全选当前视图中的构件 |
| `Delete` | 删除选中的连接（Trace Mode） |
| `Ctrl+Z` | 撤销 |
| `Ctrl+Y` | 重做 |
| `Esc` | 取消当前操作 |

---

## 9. 最佳实践

### 9.1 数据清洗

1. **先修复拓扑**: 在 Trace Mode 中修复所有拓扑错误
2. **批量设置 Z 轴**: 使用 Lift Mode 批量设置相同楼层的构件高度
3. **及时归类**: 将构件归类到正确的分项
4. **验证完整性**: 提交前检查所有构件状态

### 9.2 检验批管理

1. **合理划分**: 根据项目实际情况选择划分规则
2. **人工微调**: 创建后根据实际情况调整
3. **及时提交**: 数据完整后及时提交审批

### 9.3 审批流程

1. **仔细审查**: 审批前仔细检查构件数据
2. **记录意见**: 重要问题记录审批意见
3. **及时处理**: 发现问题及时驳回并说明原因

---

## 10. 获取帮助

- **在线文档**: 查看系统帮助文档
- **技术支持**: 联系技术支持团队
- **反馈建议**: 通过系统反馈功能提交

---

*文档版本：1.0*  
*最后更新：根据 PRD v4.0 创建*

