# MEP 路由规划和管线综合排布文档更新计划

## 一、需求明确总结

### 1. 坡度属性
- **定义**：使用百分比（%）表示
- **实现**：在Pipe模型中添加 `slope: Optional[float]` 字段，单位为百分比（%）
- **规则**：正数表示向下（重力流），负数表示向上（倒坡，重力流禁止）
- **验证**：重力流管道必须 `slope > 0`

### 2. 空间禁止MEP管线穿过
- **实现方式**：在Space模型中添加字段
  - `forbid_horizontal_mep: bool = False` - 禁止水平MEP穿过
  - `forbid_vertical_mep: bool = False` - 禁止竖向MEP穿过
- **权限**：MEP专业负责人和总工可以设置

### 3. 碰撞报警范围
- **范围**：包括MEP元素之间的碰撞和MEP与建筑结构（梁、柱、墙、楼板）的碰撞
- **处理时机**：统一在管线综合排布阶段解决
- **优先级**：与梁、柱的碰撞是最高优先级解决项
- **状态标识**：在完成管线综合排布前，显示"未完成管线综合排布"，不报警

### 4. 竖向管线判定
- **判定标准**：通过几何路径判断，如果路径的Z方向变化超过阈值（建议>1米），判定为竖向管线
- **路由规划**：竖向管线不参与自动路由规划，由MEP专业负责人手动调整位置
- **管线综合排布**：竖向管线要尽量贴近附近的墙、柱，避免与其他竖向管线和水平管线的连接处碰撞

### 5. 避障优先级冲突处理
当优先级相同时，按以下顺序处理：
1. **少翻弯**（优先）
2. **较小管径/截面积避让较大管径/截面积**
3. **尽量贴近本楼层顶板**

### 6. 管道配件附件空间
- **实现方式**：在配置文件中定义
- **支持**：全局默认值和按元素类型的覆盖值
- **默认值**：5cm的检修操作空间

### 7. 防火封堵和防水套管生成
- **生成时机**：完成管线综合排布，点击确认通过审批时生成节点
- **类型**：
  - 有防火要求的楼板/内墙：设置同防火等级的防火封堵
  - 有防水要求的楼板/墙体：设置防水套管
    - 重力流管道、有压管道：默认刚性防水套管（用户可改为柔性）
    - 风管、桥架穿楼板：设置挡水台
  - 无防火/防水要求的墙：设置一般穿墙套管
  - 无防火/防水要求的楼板：设置一般穿楼板套管

## 二、文档更新清单

### 2.1 新建文档

#### 1. `docs/MEP_ROUTING_DETAILED.md` - MEP路由规划详细规格文档
**内容**：
- 权限与流程（MEP专业负责人负责）
- 路由规划阶段详细说明
  - 竖向管线处理（不参与自动路由，手动调整）
  - 水平管线约束（必须穿过楼层内空间）
  - 端点固定（不能调整）
  - 最短路由目标
  - 原始路由约束（不能经过原始路由未经过的房间）
  - 空间限制设置
  - 分步路由规划（按分项/系统/规格区间，可选组合）
  - 预览机制（虚线/半透明显示，确认后应用）
- 管线综合排布阶段详细说明
  - 3D空间操作
  - 局部平移和翻弯
  - 目标优先级：避开碰撞 > 贴近顶板 > 少翻弯
  - 竖向管线处理（贴近墙、柱）
- 阶段转换：路由规划完成后进入管线综合排布，3D阶段可退回2D

#### 2. `docs/MEP_COORDINATION.md` - 管线综合排布规格文档
**内容**：
- 3D管线综合排布的目标和约束
- 碰撞检测规则（包括MEP与结构碰撞）
- 避让优先级系统（5级默认优先级）
- 优先级冲突处理规则
- 翻弯规则
- 贴近顶板规则
- 竖向管线贴近墙、柱规则
- 梁、柱碰撞最高优先级处理

#### 3. `docs/MEP_SYSTEM_PRIORITY.md` - MEP系统优先级配置文档
**内容**：
- 默认优先级配置（5级系统）
  1. 重力流管道（重力排水、重力雨水、冷凝水等）
  2. 大截面风管（防排烟、空调风、新风、送排风等）
  3. 大口径有压管道（消防、给水、冷冻水、冷却水、生活热水、供暖主干管道等）
  4. 电缆桥架（强电桥架、弱电桥架等）
  5. 小口径有压管道及电线导管（消防、给水、冷冻水、生活热水、供暖支管）
- 附加考虑因素
  - 管道附着物（保温层、隔音层、保护层、防火包裹）
  - 管道配件附件（阀门手柄、执行机构、检修口、检修门操作空间）
- 用户自定义优先级配置（按子分部/管线材质/管线规格区间）
- 优先级冲突处理策略
- 配置界面设计

#### 4. `docs/MEP_PENETRATION.md` - 穿墙/穿楼板节点生成文档
**内容**：
- 防火封堵节点生成规则
- 防水套管节点生成规则（刚性/柔性）
- 挡水台节点生成规则
- 一般穿墙套管节点生成规则
- 一般穿楼板套管节点生成规则
- 生成时机（完成管线综合排布确认通过审批时）

### 2.2 更新现有文档

#### 1. `docs/MEP_ROUTING.md` - 更新现有路由规划文档
**更新内容**：
- 添加坡度属性说明（百分比%）
- 添加障碍物查询和处理说明
- 添加空间限制说明（Space模型字段）
- 更新路由规划流程（2D路由→3D排布，可退回）
- 添加竖向/水平管线区分说明（Z方向变化阈值）
- 添加原始路由约束说明（不能经过未经过的房间）
- 添加端点固定约束
- 添加分步路由规划说明
- 添加预览确认机制说明

#### 2. `docs/API.md` - 更新API文档
**更新内容**：
- 添加障碍物查询API端点（`GET /api/v1/routing/obstacles`）
- 添加批量路由规划API（`POST /api/v1/routing/batch`）
- 添加管线综合排布API（`POST /api/v1/routing/coordination`）
- 添加空间限制设置API（`PUT /api/v1/spaces/{space_id}/mep-restrictions`）
- 添加优先级配置API（`GET/PUT /api/v1/routing/priority-config`）
- 添加路由规划状态管理API（`PUT /api/v1/routing/status`）
- 更新路径计算API（添加坡度、原始路径约束等参数）

#### 3. `docs/RULE_ENGINE.md` - 更新规则引擎文档
**更新内容**：
- 添加坡度验证规则（重力流必须>0）
- 添加空间限制规则（禁止穿过的空间）
- 添加碰撞检测规则（MEP与MEP、MEP与结构）
- 添加避障优先级规则（5级系统）
- 添加优先级冲突处理规则
- 添加竖向/水平管线判定规则
- 添加原始路由约束规则

#### 4. `docs/ARCHITECTURE.md` - 更新架构文档
**更新内容**：
- 路由规划服务架构
- 管线综合排布服务架构
- 障碍物查询服务架构
- 优先级管理服务架构
- 碰撞检测服务架构
- 穿墙/穿楼板节点生成服务架构

### 2.3 代码模型更新

#### 1. `backend/app/models/speckle/mep.py` - 添加坡度属性
**更新内容**：
```python
class Pipe(SpeckleBuiltElementBase):
    # ... 现有字段 ...
    slope: Optional[float] = Field(
        None, 
        description='管道坡度（百分比%，正数表示向下，负数表示向上）'
    )
```

#### 2. `backend/app/models/speckle/spatial.py` - 添加空间限制属性
**更新内容**：
```python
class Space(SpeckleBuiltElementBase):
    # ... 现有字段 ...
    forbid_horizontal_mep: bool = Field(
        False,
        description='禁止水平MEP管线穿过此空间'
    )
    forbid_vertical_mep: bool = Field(
        False,
        description='禁止竖向MEP管线穿过此空间'
    )
```

#### 3. `backend/app/config/rules/mep_routing_config.json` - 扩展配置
**更新内容**：
- 添加系统优先级配置（5级系统）
- 添加检修空间配置（全局默认值和按类型覆盖值）
- 添加坡度约束配置（重力流最小坡度）
- 添加竖向管线判定阈值配置

#### 4. `backend/app/models/gb50300/element.py` - 扩展Element模型
**更新内容**：
- 添加路由规划状态字段：`routing_status: Literal["pending", "routing", "coordinating", "completed"]`
- 添加原始路由路径字段：`original_route_geometry: Optional[Geometry2D]`（用于约束新路由不能经过未经过的房间）
- 添加管线方向字段：`pipe_orientation: Optional[Literal["horizontal", "vertical"]]`（缓存竖向/水平判定结果）

## 三、文档更新优先级

### 高优先级（必须立即更新）
1. **`docs/MEP_ROUTING_DETAILED.md`** - 核心需求规格文档（新建）
2. **`backend/app/models/speckle/mep.py`** - 添加坡度属性（代码变更）
3. **`backend/app/models/speckle/spatial.py`** - 添加空间限制属性（代码变更）
4. **`docs/MEP_ROUTING.md`** - 更新现有路由规划文档

### 中优先级（尽快更新）
5. **`docs/MEP_COORDINATION.md`** - 管线综合排布规格（新建）
6. **`docs/MEP_SYSTEM_PRIORITY.md`** - 优先级配置文档（新建）
7. **`backend/app/config/rules/mep_routing_config.json`** - 扩展配置
8. **`docs/API.md`** - API文档更新

### 中低优先级（重要但可稍后）
9. **`docs/MEP_PENETRATION.md`** - 穿墙/穿楼板节点生成文档（新建）
10. **`docs/RULE_ENGINE.md`** - 规则引擎文档
11. **`docs/ARCHITECTURE.md`** - 架构文档

### 低优先级（后续更新）
12. **`backend/app/models/gb50300/element.py`** - Element模型扩展（可能需要数据库迁移，需谨慎）

## 四、实施步骤建议

### Phase 1: 数据模型和配置（基础）
1. 更新Pipe模型添加slope属性
2. 更新Space模型添加空间限制属性
3. 扩展mep_routing_config.json添加优先级配置、检修空间配置、坡度约束配置

### Phase 2: 核心文档（规格）
4. 创建MEP_ROUTING_DETAILED.md（包含所有路由规划详细规格）
5. 创建MEP_COORDINATION.md（管线综合排布规格）
6. 更新MEP_ROUTING.md（整合新需求）

### Phase 3: 配置和优先级文档
7. 创建MEP_SYSTEM_PRIORITY.md（优先级系统文档）
8. 创建MEP_PENETRATION.md（穿墙/穿楼板节点生成文档）

### Phase 4: API和规则文档
9. 更新API.md（添加新API端点）
10. 更新RULE_ENGINE.md（添加新规则）

### Phase 5: 架构文档（可选）
11. 更新ARCHITECTURE.md（如果存在）

### Phase 6: 数据库模型扩展（需谨慎，可能涉及迁移）
12. 更新Element模型（添加路由状态、原始路径等字段，需评估数据库迁移影响）

## 五、关键设计决策记录

### 1. 坡度单位
- **决策**：使用百分比（%）
- **理由**：行业标准，易于理解和验证
- **实现**：正数=向下，负数=向上（倒坡）

### 2. 碰撞处理时机
- **决策**：统一在管线综合排布阶段解决，之前不报警
- **理由**：避免过早报警干扰路由规划，统一在3D空间解决更高效
- **例外**：梁、柱碰撞是最高优先级

### 3. 竖向管线判定
- **决策**：Z方向变化>1米判定为竖向
- **理由**：简单明确，符合工程实践
- **处理**：不参与自动路由，手动调整；综合排布时贴近墙、柱

### 4. 优先级冲突处理
- **决策**：少翻弯 > 较小管径避让较大管径 > 贴近顶板
- **理由**：成本、功能、空间利用的综合考虑

### 5. 穿墙/穿楼板节点生成
- **决策**：完成管线综合排布确认通过审批时生成
- **理由**：确保路径最终确定后再生成节点，避免重复生成

