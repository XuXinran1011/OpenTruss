name: Performance Tests

on:
  schedule:
    # 每天凌晨2点运行（UTC时间）
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_type:
        description: '测试类型 (locust/k6)'
        required: true
        default: 'locust'
        type: choice
        options:
          - locust
          - k6

jobs:
  performance:
    runs-on: ubuntu-latest
    
    services:
      memgraph:
        image: memgraph/memgraph:latest
        ports:
          - 7687:7687
          - 7444:7444
        options: >-
          --health-cmd "echo 'RETURN 1' | mgconsole"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install backend dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Initialize database schema
        working-directory: ./backend
        env:
          MEMGRAPH_HOST: localhost
          MEMGRAPH_PORT: 7687
        run: |
          python -c "from app.services.schema import initialize_schema; from app.utils.memgraph import MemgraphClient; initialize_schema(MemgraphClient())"
      
      - name: Start backend server
        working-directory: ./backend
        env:
          MEMGRAPH_HOST: localhost
          MEMGRAPH_PORT: 7687
        run: |
          uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          sleep 5
      
      - name: Run Locust performance tests
        if: github.event.inputs.test_type == 'locust' || github.event_name == 'schedule'
        working-directory: ./backend
        run: |
          locust -f tests/performance/locust/comprehensive_load_test.py \
            --host http://localhost:8000 \
            --users 50 \
            --spawn-rate 5 \
            --run-time 5m \
            --headless \
            --html tests/performance/reports/locust_report.html \
            --csv tests/performance/reports/locust
        continue-on-error: true
      
      - name: Install k6
        if: github.event.inputs.test_type == 'k6'
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6
      
      - name: Run k6 performance tests
        if: github.event.inputs.test_type == 'k6'
        working-directory: ./backend/tests/performance/k6
        run: |
          k6 run --config k6.config.js scenarios.js
          k6 run --config k6.config.js auth.js
        continue-on-error: true
      
      - name: Upload performance test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-reports
          path: |
            backend/tests/performance/reports/
            backend/tests/performance/k6/
          retention-days: 30

